angular
  .module('walletApp')
  .controller('CoinifyCountryController', CoinifyCountryController);

function CoinifyCountryController ($scope, country, MyWallet, buySell) {
  $scope.countries = country;

  let blacklist = [{'Name': 'Albania', 'Code': 'AL'},
                   {'Name': 'Algeria', 'Code': 'DZ'},
                   {'Name': 'American Samoa', 'Code': 'AS'},
                   {'Name': 'Andorra', 'Code': 'AD'},
                   {'Name': 'Angola', 'Code': 'AO'},
                   {'Name': 'Anguilla', 'Code': 'AI'},
                   {'Name': 'Antigua and Barbuda', 'Code': 'AG'},
                   {'Name': 'Argentina', 'Code': 'AR'},
                   {'Name': 'Armenia', 'Code': 'AM'},
                   {'Name': 'Aruba', 'Code': 'AW'},
                   {'Name': 'Australia', 'Code': 'AU'},
                   {'Name': 'Angola', 'Code': 'AO'},
                   {'Name': 'Azerbaijan', 'Code': 'AZ'},
                   {'Name': 'Bahamas', 'Code': 'BS'},
                   {'Name': 'Bahrain', 'Code': 'BH'},
                   {'Name': 'Bangladesh', 'Code': 'BD'},
                   {'Name': 'Barbados', 'Code': 'BB'},
                   {'Name': 'Belize', 'Code': 'BZ'},
                   {'Name': 'Benin', 'Code': 'BJ'},
                   {'Name': 'Bermuda', 'Code': 'BM'},
                   {'Name': 'Bhutan', 'Code': 'BT'},
                   {'Name': 'Bolivia, Plurinational State of', 'Code': 'BO'},
                   {'Name': 'Bonaire, Sint Eustatius and Saba', 'Code': 'BQ'},
                   {'Name': 'Bosnia and Herzegovina', 'Code': 'BA'},
                   {'Name': 'Botswana', 'Code': 'BW'},
                   {'Name': 'Bouvet Island', 'Code': 'BV'},
                   {'Name': 'Brazil', 'Code': 'BR'},
                   {'Name': 'British Indian Ocean Territory', 'Code': 'IO'},
                   {'Name': 'Brunei Darussalam', 'Code': 'BN'},
                   {'Name': 'Burkina Faso', 'Code': 'BF'},
                   {'Name': 'Burundi', 'Code': 'BI'},
                   {'Name': 'Cambodia', 'Code': 'KH'},
                   {'Name': 'Cameroon', 'Code': 'CM'},
                   {'Name': 'Canada', 'Code': 'CA'},
                   {'Name': 'Cape Verde', 'Code': 'CV'},
                   {'Name': 'Cayman Islands', 'Code': 'KY'},
                   {'Name': 'Chad', 'Code': 'TD'},
                   {'Name': 'Chile', 'Code': 'CL'},
                   {'Name': 'China', 'Code': 'CN'},
                   {'Name': 'Christmas Island', 'Code': 'CX'},
                   {'Name': 'Cocos (Keeling) Islands', 'Code': 'CC'},
                   {'Name': 'Colombia', 'Code': 'CO'},
                   {'Name': 'Comoros', 'Code': 'KM'},
                   {'Name': 'Cook Islands', 'Code': 'CK'},
                   {'Name': 'Costa Rica', 'Code': 'CR'},
                   {'Name': 'Cura√ßao', 'Code': 'CW'},
                   {'Name': 'Djibouti', 'Code': 'DJ'},
                   {'Name': 'Dominica', 'Code': 'DM'},
                   {'Name': 'Dominican Republic', 'Code': 'DO'},
                   {'Name': 'Ecuador', 'Code': 'EC'},
                   {'Name': 'Egypt', 'Code': 'EG'},
                   {'Name': 'El Salvador', 'Code': 'SV'},
                   {'Name': 'Ethiopia', 'Code': 'ET'},
                   {'Name': 'Falkland Islands (Malvinas)', 'Code': 'FK'},
                   {'Name': 'Faroe Islands', 'Code': 'FO'},
                   {'Name': 'Fiji', 'Code': 'FJ'},
                   {'Name': 'French Polynesia', 'Code': 'PF'},
                   {'Name': 'French Southern Territories', 'Code': 'TF'},
                   {'Name': 'Gabon', 'Code': 'GA'},
                   {'Name': 'Gambia', 'Code': 'GM'},
                   {'Name': 'Georgia', 'Code': 'GE'},
                   {'Name': 'Ghana', 'Code': 'GH'},
                   {'Name': 'Greenland', 'Code': 'GL'},
                   {'Name': 'Grenada', 'Code': 'GD'},
                   {'Name': 'Guam', 'Code': 'GU'},
                   {'Name': 'Guatemala', 'Code': 'GT'},
                   {'Name': 'Guyana', 'Code': 'GY'},
                   {'Name': 'Haiti', 'Code': 'HT'},
                   {'Name': 'Heard Island and McDonald Islands', 'Code': 'HM'},
                   {'Name': 'Honduras', 'Code': 'HN'},
                   {'Name': 'Hong Kong', 'Code': 'HK'},
                   {'Name': 'India', 'Code': 'IN'},
                   {'Name': 'Indonesia', 'Code': 'ID'},
                   {'Name': 'Israel', 'Code': 'IL'},
                   {'Name': 'Jamaica', 'Code': 'JM'},
                   {'Name': 'Japan', 'Code': 'JP'},
                   {'Name': 'Jordan', 'Code': 'JO'},
                   {'Name': 'Kazakhstan', 'Code': 'KZ'},
                   {'Name': 'Kenya', 'Code': 'KE'},
                   {'Name': 'Kiribati', 'Code': 'KI'},
                   {'Name': 'Korea, Republic of', 'Code': 'KR'},
                   {'Name': 'Kuwait', 'Code': 'KW'},
                   {'Name': 'Kyrgyzstan', 'Code': 'KG'},
                   {'Name': 'Lao People\'s Democratic Republic', 'Code': 'LA'},
                   {'Name': 'Lesotho', 'Code': 'LS'},
                   {'Name': 'Macao', 'Code': 'MO'},
                   {'Name': 'Macedonia, the Former Yugoslav Republic of', 'Code': 'MK'},
                   {'Name': 'Madagascar', 'Code': 'MG'},
                   {'Name': 'Malawi', 'Code': 'MW'},
                   {'Name': 'Malaysia', 'Code': 'MY'},
                   {'Name': 'Maldives', 'Code': 'MV'},
                   {'Name': 'Mali', 'Code': 'ML'},
                   {'Name': 'Marshall Islands', 'Code': 'MH'},
                   {'Name': 'Mauritania', 'Code': 'MR'},
                   {'Name': 'Mauritius', 'Code': 'MU'},
                   {'Name': 'Mexico', 'Code': 'MX'},
                   {'Name': 'Micronesia, Federated States of', 'Code': 'FM'},
                   {'Name': 'Moldova, Republic of', 'Code': 'MD'},
                   {'Name': 'Mongolia', 'Code': 'MN'},
                   {'Name': 'Montenegro', 'Code': 'ME'},
                   {'Name': 'Montserrat', 'Code': 'MS'},
                   {'Name': 'Morocco', 'Code': 'MA'},
                   {'Name': 'Mozambique', 'Code': 'MZ'},
                   {'Name': 'Namibia', 'Code': 'NA'},
                   {'Name': 'Nauru', 'Code': 'NR'},
                   {'Name': 'Nepal', 'Code': 'NP'},
                   {'Name': 'New Caledonia', 'Code': 'NC'},
                   {'Name': 'New Zealand', 'Code': 'NZ'},
                   {'Name': 'Nicaragua', 'Code': 'NI'},
                   {'Name': 'Niger', 'Code': 'NE'},
                   {'Name': 'Nigeria', 'Code': 'NG'},
                   {'Name': 'Niue', 'Code': 'NU'},
                   {'Name': 'Norfolk Island', 'Code': 'NF'},
                   {'Name': 'Northern Mariana Islands', 'Code': 'MP'},
                   {'Name': 'Oman', 'Code': 'OM'},
                   {'Name': 'Pakistan', 'Code': 'PK'},
                   {'Name': 'Palau', 'Code': 'PW'},
                   {'Name': 'Palestine, State of', 'Code': 'PS'},
                   {'Name': 'Panama', 'Code': 'PA'},
                   {'Name': 'Papua New Guinea', 'Code': 'PG'},
                   {'Name': 'Paraguay', 'Code': 'PY'},
                   {'Name': 'Peru', 'Code': 'PE'},
                   {'Name': 'Philippines', 'Code': 'PH'},
                   {'Name': 'Pitcairn', 'Code': 'PN'},
                   {'Name': 'Puerto Rico', 'Code': 'PR'},
                   {'Name': 'Qatar', 'Code': 'QA'},
                   {'Name': 'Rwanda', 'Code': 'RW'},
                   {'Name': 'Saint Helena, Ascension and Tristan da Cunha', 'Code': 'SH'},
                   {'Name': 'Saint Kitts and Nevis', 'Code': 'KN'},
                   {'Name': 'Saint Lucia', 'Code': 'LC'},
                   {'Name': 'Saint Vincent and the Grenadines', 'Code': 'VC'},
                   {'Name': 'Samoa', 'Code': 'WS'},
                   {'Name': 'Sao Tome and Principe', 'Code': 'ST'},
                   {'Name': 'Saudi Arabia', 'Code': 'SA'},
                   {'Name': 'Senegal', 'Code': 'SN'},
                   {'Name': 'Serbia', 'Code': 'RS'},
                   {'Name': 'Seychelles', 'Code': 'SC'},
                   {'Name': 'Sierra Leone', 'Code': 'SL'},
                   {'Name': 'Singapore', 'Code': 'SG'},
                   {'Name': 'Sint Maarten (Dutch part)', 'Code': 'SX'},
                   {'Name': 'Solomon Islands', 'Code': 'SB'},
                   {'Name': 'South Africa', 'Code': 'ZA'},
                   {'Name': 'South Georgia and the South Sandwich Islands', 'Code': 'GS'},
                   {'Name': 'Sri Lanka', 'Code': 'LK'},
                   {'Name': 'Suriname', 'Code': 'SR'},
                   {'Name': 'Svalbard and Jan Mayen', 'Code': 'SJ'},
                   {'Name': 'Swaziland', 'Code': 'SZ'},
                   {'Name': 'Taiwan, Province of China', 'Code': 'TW'},
                   {'Name': 'Tajikistan', 'Code': 'TJ'},
                   {'Name': 'Tanzania, United Republic of', 'Code': 'TZ'},
                   {'Name': 'Thailand', 'Code': 'TH'},
                   {'Name': 'Timor-Leste', 'Code': 'TL'},
                   {'Name': 'Togo', 'Code': 'TG'},
                   {'Name': 'Tokelau', 'Code': 'TK'},
                   {'Name': 'Tonga', 'Code': 'TO'},
                   {'Name': 'Trinidad and Tobago', 'Code': 'TT'},
                   {'Name': 'Turkey', 'Code': 'TR'},
                   {'Name': 'Turkmenistan', 'Code': 'TM'},
                   {'Name': 'Turks and Caicos Islands', 'Code': 'TC'},
                   {'Name': 'Tuvalu', 'Code': 'TV'},
                   {'Name': 'Uganda', 'Code': 'UG'},
                   {'Name': 'Ukraine', 'Code': 'UA'},
                   {'Name': 'United Arab Emirates', 'Code': 'AE'},
                   {'Name': 'United States', 'Code': 'US'},
                   {'Name': 'United States Minor Outlying Islands', 'Code': 'UM'},
                   {'Name': 'Uruguay', 'Code': 'UY'},
                   {'Name': 'Uzbekistan', 'Code': 'UZ'},
                   {'Name': 'Vanuatu', 'Code': 'VU'},
                   {'Name': 'Viet Nam', 'Code': 'VN'},
                   {'Name': 'Virgin Islands, British', 'Code': 'VG'},
                   {'Name': 'Wallis and Futuna', 'Code': 'WF'},
                   {'Name': 'Western Sahara', 'Code': 'EH'},
                   {'Name': 'Zambia', 'Code': 'ZM'}];

  $scope.countryCodeGuess = $scope.countries.countryCodes.filter(country => country['Code'] === MyWallet.wallet.accountInfo.countryCodeGuess)[0];
  if ($scope.countryCodeGuess) $scope.fields.countryCode = $scope.countryCodeGuess['Code'];

  $scope.$watch('fields.countryCode', (newVal) => {
    $scope.$parent.isCountryBlacklisted = blacklist.some((country) => country['Code'] === newVal);
    if ($scope.$parent.isCountryBlacklisted) $scope.isDisabled();
  });

  $scope.signupForAccess = () => {
    let email = encodeURIComponent($scope.$parent.fields.email);
    let country = $scope.countries.countryCodes.filter(c => c['Code'] === $scope.fields.countryCode)[0]['Name'];
    buySell.signupForAccess(email, country);
  };

  $scope.checkStartsWith = (viewValue, search) => {
    let startsWith = (a, b) => a.toLowerCase().lastIndexOf(b.toLowerCase(), 0) === 0;

    if (!search.length) return true;
    else {
      return viewValue.toLowerCase && startsWith(viewValue, search) ||
             viewValue.name && startsWith(viewValue.name, search);
    }
  };
}
